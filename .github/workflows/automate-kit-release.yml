name: automate-kit-release

on:
  workflow_dispatch: { }
  push:
    tags:
      - "automate-kit-*"

permissions:
  contents: write

concurrency:
  group: automate-kit-release
  cancel-in-progress: false

env:
  ASSET_ZIP: automate-kit.zip
  ASSET_SHA: automate-kit.sha256

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build kit zip from .automating
        shell: bash
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist
          if [ ! -d ".automating" ]; then
            echo "Missing .automating directory."
            exit 1
          fi
          (cd . && zip -r "dist/${ASSET_ZIP}" .automating >/dev/null)
          (cd dist && sha256sum "${ASSET_ZIP}" | awk '{print $1}' > "${ASSET_SHA}")

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/${{ env.ASSET_ZIP }}
            dist/${{ env.ASSET_SHA }}

      - name: Create GitHub App token (optional)
        id: app
        if: ${{ vars.AUT0MATER_APP_ID != '' && secrets.AUT0MATER_APP_PRIVATE_KEY != '' }}
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.AUT0MATER_APP_ID }}
          private-key: ${{ secrets.AUT0MATER_APP_PRIVATE_KEY }}

      - name: Dispatch to clients (optional)
        if: ${{ secrets.AUTOMATE_DISPATCH_TOKEN != '' || steps.app.outputs.token != '' }}
        shell: bash
        env:
          GH_TOKEN: ${{ steps.app.outputs.token != '' && steps.app.outputs.token || secrets.AUTOMATE_DISPATCH_TOKEN }}
        run: |
          set -euo pipefail
          if [ ! -f ".automating/client/allowlist.json" ]; then
            echo "No .automating/client/allowlist.json; skip dispatch."
            exit 0
          fi

          event_type=$(jq -r '.event_type // "automate-kit-release"' .automating/client/allowlist.json)
          topic=$(jq -r '.topic // ""' .automating/client/allowlist.json)

          repos=$(jq -r '.repos[]?' .automating/client/allowlist.json 2>/dev/null || true)

          # Optional: discover by topic in the same owner/org
          if [ -n "$topic" ]; then
            owner="${GITHUB_REPOSITORY_OWNER}"
            q="topic:${topic} user:${owner} archived:false fork:false"
            echo "Discover by topic: $q"
            discovered=$(gh api "search/repositories" -f q="$q" --jq '.items[].full_name' || true)
            repos=$(printf "%s
          %s
          " "$repos" "$discovered" | sed '/^$/d' | sort -u)
          fi

          if [ -z "$repos" ]; then
          echo "No repos to dispatch."
          exit 0
          fi
          
          tag="${GITHUB_REF_NAME}"
          echo "$repos" | while read -r repo; do
          echo "Dispatch -> $repo tag=$tag"
          gh api "repos/${repo}/dispatches" -X POST               -f event_type="${event_type}"               -f client_payload[tag]="${tag}"
          done
