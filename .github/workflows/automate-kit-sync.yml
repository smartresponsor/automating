name: automate-kit-sync

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve Automater script path
        shell: pwsh
        run: |
          $candidates = @(
            "$env:GITHUB_WORKSPACE/.automation/tool/automater-pack-sync.ps1"
          )
          $found = $null
          foreach ($p in $candidates) {
            if (Test-Path $p) { $found = $p; break }
          }
          if (-not $found) {
            Write-Host "pwd:"
            pwd
            Write-Host "ls root:"
            Get-ChildItem -Force $env:GITHUB_WORKSPACE | Format-Table -AutoSize
            Write-Host "ls .automation:"
            if (Test-Path "$env:GITHUB_WORKSPACE/.automation") { Get-ChildItem -Force "$env:GITHUB_WORKSPACE/.automation" -Recurse -Depth 2 | Select-Object FullName }
            Write-Host "ls .automate:"
            if (Test-Path "$env:GITHUB_WORKSPACE/.automate") { Get-ChildItem -Force "$env:GITHUB_WORKSPACE/.automate" -Recurse -Depth 2 | Select-Object FullName }
            Write-Error "automater-pack-sync.ps1 not found in any known location"
          }
          "AUTOMATER_SCRIPT=$found" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "AUTOMATER_SCRIPT=$found"

      - name: Automater pack sync
        shell: pwsh
        run: |
          pwsh -NoProfile -File "$env:AUTOMATER_SCRIPT" -OnlyId "automate-kit"
